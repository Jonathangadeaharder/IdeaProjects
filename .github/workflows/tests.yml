name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  backend:
    name: Backend Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: Backend
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
          pip install diff-cover

      - name: Run pytest (fast suites, no skipped/deselected)
        run: |
          pytest -q tests/api tests/core tests/services tests/management tests/integration/test_inprocess_*.py --cov-fail-under=70 --cov-report=xml

      - name: Generate diff coverage markdown (PRs only)
        if: github.event_name == 'pull_request'
        run: |
          diff-cover coverage.xml --compare-branch=origin/${{ github.base_ref }} --markdown-report diff_coverage.md || true

      - name: Generate branch diff coverage markdown (PRs only)
        if: github.event_name == 'pull_request'
        run: |
          diff-cover coverage.xml --compare-branch=origin/${{ github.base_ref }} --branch-coverage --markdown-report branch_diff_coverage.md || true

      - name: Generate overall coverage markdown (PRs only)
        if: github.event_name == 'pull_request'
        run: |
          python - << 'PY'
          import xml.etree.ElementTree as ET, sys
          p = 'coverage.xml'
          try:
              root = ET.parse(p).getroot()
          except Exception as e:
              print(f'Cannot parse {p}: {e}')
              sys.exit(0)
          def pct(x):
              try:
                  return f"{float(x)*100:.1f}%"
              except Exception:
                  return 'N/A'
          overall_line = pct(root.get('line-rate', 0))
          overall_branch = pct(root.get('branch-rate', 0))
          # Collect package line-rates
          packages = []
          for pkg in root.findall('.//packages/package'):
              name = pkg.get('name','')
              lr = pkg.get('line-rate','')
              br = pkg.get('branch-rate','')
              packages.append((name, pct(lr), pct(br)))
          def pick(name):
              # Prefer exact match, fallback to prefix match
              for n,lv,bv in packages:
                  if n == name:
                      return lv,bv
              for n,lv,bv in packages:
                  if n.startswith(name + '/'):
                      return lv,bv
              return 'N/A','N/A'
          with open('coverage_comment.md','w', encoding='utf-8') as f:
              f.write('# Coverage Summary\n\n')
              f.write(f'- Overall: Lines {overall_line}, Branches {overall_branch}\n')
              for n in ('api','core','management'):
                  ln, bn = pick(n)
                  f.write(f'- {n}: Lines {ln}, Branches {bn}\n')
              f.write('\n## Diff Coverage\n')
          PY
          if [ -f diff_coverage.md ]; then cat diff_coverage.md >> coverage_comment.md; fi
          echo "" >> coverage_comment.md
          echo "## Diff Branch Coverage" >> coverage_comment.md
          if [ -f branch_diff_coverage.md ]; then cat branch_diff_coverage.md >> coverage_comment.md; fi

      - name: Post coverage comment
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: coverage
          path: Backend/coverage_comment.md

      - name: Diff coverage (PRs only, 90% min)
        if: github.event_name == 'pull_request'
        run: |
          git fetch origin ${{ github.base_ref }} --depth=1 || true
          diff-cover coverage.xml --compare-branch=origin/${{ github.base_ref }} --fail-under=90

      - name: Diff branch coverage (PRs only, 80% min)
        if: github.event_name == 'pull_request'
        run: |
          git fetch origin ${{ github.base_ref }} --depth=1 || true
          diff-cover coverage.xml --compare-branch=origin/${{ github.base_ref }} --branch-coverage --fail-under=80

      - name: Per-package diff coverage (lines) 90% min
        if: github.event_name == 'pull_request'
        run: |
          set -e
          git fetch origin ${{ github.base_ref }} --depth=1 || true
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }}... | tr '\n' ' ')
          echo "Changed files: $CHANGED"
          if echo "$CHANGED" | grep -q '^Backend/api/'; then
            echo 'Enforcing API diff line coverage >= 90%'
            diff-cover coverage.xml --compare-branch=origin/${{ github.base_ref }} --include Backend/api/* --fail-under=90
          fi
          if echo "$CHANGED" | grep -q '^Backend/core/'; then
            echo 'Enforcing CORE diff line coverage >= 90%'
            diff-cover coverage.xml --compare-branch=origin/${{ github.base_ref }} --include Backend/core/* --fail-under=90
          fi
          if echo "$CHANGED" | grep -q '^Backend/management/'; then
            echo 'Enforcing MANAGEMENT diff line coverage >= 90%'
            diff-cover coverage.xml --compare-branch=origin/${{ github.base_ref }} --include Backend/management/* --fail-under=90
          fi

      - name: Per-package diff coverage (branches) 80% min
        if: github.event_name == 'pull_request'
        run: |
          set -e
          git fetch origin ${{ github.base_ref }} --depth=1 || true
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }}... | tr '\n' ' ')
          if echo "$CHANGED" | grep -q '^Backend/api/'; then
            echo 'Enforcing API diff branch coverage >= 80%'
            diff-cover coverage.xml --compare-branch=origin/${{ github.base_ref }} --branch-coverage --include Backend/api/* --fail-under=80
          fi
          if echo "$CHANGED" | grep -q '^Backend/core/'; then
            echo 'Enforcing CORE diff branch coverage >= 80%'
            diff-cover coverage.xml --compare-branch=origin/${{ github.base_ref }} --branch-coverage --include Backend/core/* --fail-under=80
          fi
          if echo "$CHANGED" | grep -q '^Backend/management/'; then
            echo 'Enforcing MANAGEMENT diff branch coverage >= 80%'
            diff-cover coverage.xml --compare-branch=origin/${{ github.base_ref }} --branch-coverage --include Backend/management/* --fail-under=80
          fi

      - name: Upload coverage HTML
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage-html
          path: Backend/htmlcov
      - name: Upload coverage XML
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage-xml-fast
          path: Backend/coverage.xml
      - name: Upload diff coverage report
        if: github.event_name == 'pull_request' && always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-diff-coverage-md
          path: Backend/diff_coverage.md
      - name: Upload branch diff coverage report
        if: github.event_name == 'pull_request' && always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-branch-diff-coverage-md
          path: Backend/branch_diff_coverage.md
      - name: Upload coverage comment
        if: github.event_name == 'pull_request' && always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage-comment-md
          path: Backend/coverage_comment.md

      - name: Append coverage summary to job summary
        if: always()
        run: |
          if [ -f Backend/coverage_comment.md ]; then \
            echo "## Coverage Summary" >> $GITHUB_STEP_SUMMARY; \
            cat Backend/coverage_comment.md >> $GITHUB_STEP_SUMMARY; \
          fi

  frontend:
    name: Frontend Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: Frontend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'yarn'
          cache-dependency-path: Frontend/yarn.lock

      - name: Install deps
        run: |
          corepack enable
          yarn install --frozen-lockfile

      - name: Run Vitest
        run: yarn test --coverage

      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: Frontend/coverage

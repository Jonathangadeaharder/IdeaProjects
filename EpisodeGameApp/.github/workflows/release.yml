name: Release Pipeline

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string
      release_type:
        description: 'Type of release'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
          - prerelease

jobs:
  validate-release:
    name: Validate Release
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"
          
      - name: Validate version format
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if [[ ! $VERSION =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$ ]]; then
            echo "‚ùå Invalid version format: $VERSION"
            echo "Expected format: vX.Y.Z or vX.Y.Z-prerelease"
            exit 1
          fi
          
      - name: Run full test suite
        run: npm test -- --coverage --watchAll=false
        
      - name: Run linting
        run: npm run lint
        
      - name: Type check
        run: npx tsc --noEmit

  build-release-artifacts:
    name: Build Release Artifacts
    runs-on: ubuntu-latest
    needs: validate-release
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build web application
        run: npm run build:web
        
      - name: Create web archive
        run: |
          cd dist
          tar -czf ../web-app-${{ needs.validate-release.outputs.version }}.tar.gz .
          cd ..
          
      - name: Upload web artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-release-${{ needs.validate-release.outputs.version }}
          path: |
            web-app-${{ needs.validate-release.outputs.version }}.tar.gz
            dist/
          retention-days: 30

  build-android-release:
    name: Build Android Release
    runs-on: ubuntu-latest
    needs: validate-release
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        
      - name: Install dependencies
        run: npm ci
        
      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
            
      - name: Make gradlew executable
        run: chmod +x android/gradlew
        
      - name: Build Android Release APK
        run: |
          cd android
          ./gradlew assembleRelease
          
      - name: Sign APK
        if: ${{ env.ANDROID_KEYSTORE_BASE64 != '' }}
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          # Decode keystore
          echo $ANDROID_KEYSTORE_BASE64 | base64 -d > android/app/release.keystore
          
          # Sign APK
          cd android
          ./gradlew assembleRelease
          
      - name: Rename APK
        run: |
          mv android/app/build/outputs/apk/release/app-release.apk android/app/build/outputs/apk/release/EpisodeGameApp-${{ needs.validate-release.outputs.version }}.apk
          
      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-release-${{ needs.validate-release.outputs.version }}
          path: android/app/build/outputs/apk/release/EpisodeGameApp-${{ needs.validate-release.outputs.version }}.apk
          retention-days: 30

  build-ios-release:
    name: Build iOS Release
    runs-on: macos-latest
    needs: validate-release
    if: ${{ env.IOS_CERTIFICATE_BASE64 != '' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.0'
          bundler-cache: true
          working-directory: ios
          
      - name: Install CocoaPods
        run: |
          cd ios
          pod install
          
      - name: Setup iOS certificates
        env:
          IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
          IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
          IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
        run: |
          # Create certificates directory
          mkdir -p ~/certificates
          
          # Decode certificate
          echo $IOS_CERTIFICATE_BASE64 | base64 -d > ~/certificates/certificate.p12
          
          # Decode provisioning profile
          echo $IOS_PROVISIONING_PROFILE_BASE64 | base64 -d > ~/certificates/profile.mobileprovision
          
          # Install certificate
          security create-keychain -p "" build.keychain
          security import ~/certificates/certificate.p12 -k build.keychain -P "$IOS_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security list-keychains -s build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain
          
          # Install provisioning profile
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp ~/certificates/profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
          
      - name: Build iOS app
        run: |
          cd ios
          xcodebuild -workspace EpisodeGameApp.xcworkspace \
            -scheme EpisodeGameApp \
            -configuration Release \
            -archivePath EpisodeGameApp.xcarchive \
            archive
            
      - name: Export IPA
        run: |
          cd ios
          xcodebuild -exportArchive \
            -archivePath EpisodeGameApp.xcarchive \
            -exportPath . \
            -exportOptionsPlist ExportOptions.plist
            
      - name: Rename IPA
        run: |
          mv ios/EpisodeGameApp.ipa ios/EpisodeGameApp-${{ needs.validate-release.outputs.version }}.ipa
          
      - name: Upload iOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-release-${{ needs.validate-release.outputs.version }}
          path: ios/EpisodeGameApp-${{ needs.validate-release.outputs.version }}.ipa
          retention-days: 30

  create-github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate-release, build-release-artifacts, build-android-release]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        
      - name: Generate changelog
        id: changelog
        run: |
          # Get the previous tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREVIOUS_TAG" ]; then
            echo "changelog=Initial release" >> $GITHUB_OUTPUT
          else
            # Generate changelog from commits
            CHANGELOG=$(git log --pretty=format:"- %s" $PREVIOUS_TAG..HEAD | head -20)
            echo "changelog<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGELOG" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi
          
      - name: Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.validate-release.outputs.version }}
          release_name: Release ${{ needs.validate-release.outputs.version }}
          body: |
            ## Changes
            ${{ steps.changelog.outputs.changelog }}
            
            ## Downloads
            - **Web App**: Download the web-app-${{ needs.validate-release.outputs.version }}.tar.gz file
            - **Android**: Download the EpisodeGameApp-${{ needs.validate-release.outputs.version }}.apk file
            - **iOS**: Download the EpisodeGameApp-${{ needs.validate-release.outputs.version }}.ipa file (if available)
            
            ## Installation
            ### Web App
            1. Extract the tar.gz file
            2. Serve the contents with any web server
            
            ### Android
            1. Enable "Unknown sources" in Android settings
            2. Install the APK file
            
            ### iOS
            1. Install via TestFlight or enterprise distribution
          draft: false
          prerelease: ${{ contains(needs.validate-release.outputs.version, '-') }}
          
      - name: Upload Release Assets
        run: |
          # Upload web artifacts
          if [ -f "web-release-${{ needs.validate-release.outputs.version }}/web-app-${{ needs.validate-release.outputs.version }}.tar.gz" ]; then
            gh release upload ${{ needs.validate-release.outputs.version }} "web-release-${{ needs.validate-release.outputs.version }}/web-app-${{ needs.validate-release.outputs.version }}.tar.gz"
          fi
          
          # Upload Android artifacts
          if [ -f "android-release-${{ needs.validate-release.outputs.version }}/EpisodeGameApp-${{ needs.validate-release.outputs.version }}.apk" ]; then
            gh release upload ${{ needs.validate-release.outputs.version }} "android-release-${{ needs.validate-release.outputs.version }}/EpisodeGameApp-${{ needs.validate-release.outputs.version }}.apk"
          fi
          
          # Upload iOS artifacts (if available)
          if [ -f "ios-release-${{ needs.validate-release.outputs.version }}/EpisodeGameApp-${{ needs.validate-release.outputs.version }}.ipa" ]; then
            gh release upload ${{ needs.validate-release.outputs.version }} "ios-release-${{ needs.validate-release.outputs.version }}/EpisodeGameApp-${{ needs.validate-release.outputs.version }}.ipa"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy-web:
    name: Deploy Web App
    runs-on: ubuntu-latest
    needs: [validate-release, build-release-artifacts]
    if: ${{ env.DEPLOY_URL != '' }}
    
    steps:
      - name: Download web artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-release-${{ needs.validate-release.outputs.version }}
          
      - name: Deploy to production
        env:
          DEPLOY_URL: ${{ secrets.DEPLOY_URL }}
          DEPLOY_TOKEN: ${{ secrets.DEPLOY_TOKEN }}
        run: |
          # Extract web app
          tar -xzf web-app-${{ needs.validate-release.outputs.version }}.tar.gz
          
          # Deploy using your preferred method (example with rsync)
          # rsync -avz --delete dist/ user@server:/path/to/web/root/
          
          echo "Web app deployed to production"

  notify-release:
    name: Notify Release
    runs-on: ubuntu-latest
    needs: [create-github-release, deploy-web]
    if: always()
    
    steps:
      - name: Notify success
        if: ${{ needs.create-github-release.result == 'success' }}
        run: |
          echo "üéâ Release ${{ needs.validate-release.outputs.version }} created successfully!"
          echo "üì± Android APK and üåê Web app are available for download."
          
      - name: Notify failure
        if: ${{ needs.create-github-release.result == 'failure' }}
        run: |
          echo "‚ùå Release ${{ needs.validate-release.outputs.version }} failed!"
          echo "Check the logs for details."
          exit 1
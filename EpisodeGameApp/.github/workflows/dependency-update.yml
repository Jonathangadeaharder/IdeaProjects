name: Dependency Updates

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  update-dependencies:
    name: Update Dependencies
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Check for outdated packages
        id: outdated
        run: |
          # Get outdated packages
          OUTDATED=$(npm outdated --json || echo '{}')
          echo "outdated=$OUTDATED" >> $GITHUB_OUTPUT
          
          # Check if there are any outdated packages
          if [ "$OUTDATED" != "{}" ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "üì¶ Found outdated packages:"
            npm outdated
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "‚úÖ All packages are up to date"
          fi
          
      - name: Update patch and minor versions
        if: steps.outdated.outputs.has_updates == 'true'
        run: |
          # Update patch and minor versions only (safer updates)
          npm update
          
          # Check if package-lock.json was modified
          if git diff --quiet package-lock.json; then
            echo "No updates applied"
            echo "updates_applied=false" >> $GITHUB_ENV
          else
            echo "Updates applied"
            echo "updates_applied=true" >> $GITHUB_ENV
          fi
          
      - name: Run tests after updates
        if: env.updates_applied == 'true'
        run: |
          npm test -- --watchAll=false
          
      - name: Run linting after updates
        if: env.updates_applied == 'true'
        run: |
          npm run lint
          
      - name: Build after updates
        if: env.updates_applied == 'true'
        run: |
          npm run build:web
          
      - name: Generate update summary
        if: env.updates_applied == 'true'
        id: summary
        run: |
          # Get the changes
          CHANGES=$(git diff --name-only)
          
          # Generate summary of updated packages
          echo "## üì¶ Dependency Updates" > update_summary.md
          echo "" >> update_summary.md
          echo "The following packages have been updated:" >> update_summary.md
          echo "" >> update_summary.md
          
          # Parse package-lock.json changes (simplified)
          git diff package-lock.json | grep '"version":' | head -20 >> update_summary.md || true
          
          echo "" >> update_summary.md
          echo "### ‚úÖ Validation" >> update_summary.md
          echo "- Tests: Passed" >> update_summary.md
          echo "- Linting: Passed" >> update_summary.md
          echo "- Build: Successful" >> update_summary.md
          
          # Read summary for PR body
          SUMMARY=$(cat update_summary.md)
          echo "summary<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
      - name: Create Pull Request
        if: env.updates_applied == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update dependencies'
          title: 'üîÑ Automated Dependency Updates'
          body: ${{ steps.summary.outputs.summary }}
          branch: dependency-updates
          delete-branch: true
          labels: |
            dependencies
            automated
          reviewers: |
            # Add your team members here
          assignees: |
            # Add assignees here

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run security audit
        id: audit
        run: |
          # Run npm audit and capture output
          AUDIT_OUTPUT=$(npm audit --audit-level=moderate --json || true)
          echo "audit_output=$AUDIT_OUTPUT" >> $GITHUB_OUTPUT
          
          # Check if there are vulnerabilities
          VULNERABILITIES=$(echo $AUDIT_OUTPUT | jq '.metadata.vulnerabilities.total' 2>/dev/null || echo "0")
          echo "vulnerabilities=$VULNERABILITIES" >> $GITHUB_OUTPUT
          
          if [ "$VULNERABILITIES" -gt "0" ]; then
            echo "üö® Found $VULNERABILITIES vulnerabilities"
            npm audit --audit-level=moderate
          else
            echo "‚úÖ No security vulnerabilities found"
          fi
          
      - name: Create security issue
        if: steps.audit.outputs.vulnerabilities != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const vulnerabilities = ${{ steps.audit.outputs.vulnerabilities }};
            
            const issueBody = `
            ## üö® Security Vulnerabilities Detected
            
            Our automated security scan has detected **${vulnerabilities}** vulnerabilities in the project dependencies.
            
            ### Action Required
            1. Review the vulnerabilities listed below
            2. Update the affected packages
            3. Test the application thoroughly
            4. Close this issue once resolved
            
            ### Audit Results
            \`\`\`
            ${{ steps.audit.outputs.audit_output }}
            \`\`\`
            
            ### Automated Fix
            You can try running \`npm audit fix\` to automatically fix some vulnerabilities.
            
            ---
            *This issue was created automatically by the security audit workflow.*
            `;
            
            // Check if there's already an open security issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'security,automated',
              state: 'open'
            });
            
            if (issues.data.length === 0) {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `üö® Security Vulnerabilities Detected (${vulnerabilities} found)`,
                body: issueBody,
                labels: ['security', 'automated', 'high-priority']
              });
            } else {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                title: `üö® Security Vulnerabilities Detected (${vulnerabilities} found)`,
                body: issueBody
              });
            }

  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Check licenses
        run: |
          # Install license checker
          npm install --no-save license-checker
          
          # Define allowed licenses
          ALLOWED_LICENSES="MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;0BSD;Unlicense;WTFPL"
          
          # Check licenses
          echo "üìÑ Checking license compliance..."
          npx license-checker --onlyAllow "$ALLOWED_LICENSES" --excludePrivatePackages --summary
          
          # Generate detailed report
          npx license-checker --json --out licenses.json
          
      - name: Upload license report
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: licenses.json
          retention-days: 30

  dependency-graph:
    name: Update Dependency Graph
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Submit dependency graph
        uses: github/dependency-graph/submit@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
  notify-results:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [update-dependencies, security-audit, license-check, dependency-graph]
    if: always()
    
    steps:
      - name: Notify completion
        run: |
          echo "üîç Dependency maintenance completed:"
          echo "- Updates: ${{ needs.update-dependencies.result }}"
          echo "- Security: ${{ needs.security-audit.result }}"
          echo "- Licenses: ${{ needs.license-check.result }}"
          echo "- Graph: ${{ needs.dependency-graph.result }}"